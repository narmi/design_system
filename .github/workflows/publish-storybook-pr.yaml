name: Publish Storybook (Chromatic build from PR)
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  call-pr-workflow:
    uses: ./.github/workflows/pull_request.yml
  
  Chromatic:
    runs-on: ubuntu-latest
    needs: call-pr-workflow
    steps:
      - name: Publish to Chromatic
        id: chromatic
        uses: chromaui/action@v1
        with:
          cache: 'npm'
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

      - name: Comment storybook url in PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          cache: 'npm'
          debug: true
          pr_number: ${{github.event.number}}
          mode: recreate
          comment_tag: execution
          message: |+
            ## ðŸ“˜ Storybook Preview Available ðŸ‘€

            View the Storybook build from this PR in your browser:
            ${{ steps.chromatic.outputs.storybookUrl }}

            <sub>_(This action will publish a new comment and url if this PR is modified)_</sub>